<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Plan - Investimento Monolocale Milano</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        @media print {
            body { 
                background: white !important; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .container { max-width: none !important; margin: 0 !important; padding: 20px !important; }
            .grid { display: block !important; }
            .lg\\:grid-cols-2 > div { margin-bottom: 20px !important; }
            .shadow-lg { box-shadow: none !important; border: 1px solid #e5e7eb !important; }
            .bg-gradient-to-br { background: white !important; }
            .rounded-xl, .rounded-lg { border-radius: 8px !important; }
            .text-blue-600, .text-green-600, .text-red-600, .text-yellow-600, .text-orange-600 { 
                color: #1f2937 !important; font-weight: bold !important; 
            }
            .bg-blue-50, .bg-green-50, .bg-red-50, .bg-yellow-50, .bg-orange-50, .bg-gray-50 { 
                background: #f9fafb !important; border: 1px solid #e5e7eb !important; 
            }
            h1, h2, h3 { color: #1f2937 !important; }
            .page-break { page-break-before: always; }
        }
        
        .print-only { display: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Print Header -->
        <div class="print-only text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2" id="printTitle">Business Plan Immobiliare</h1>
            <p class="text-lg text-gray-600" id="printSubtitle">Analisi di fattibilit√† - Investimento Immobiliare</p>
            <p class="text-sm text-gray-500 mt-2" id="printDate"></p>
        </div>

        <!-- Header -->
        <div class="text-center mb-8 no-print">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Business Plan Immobiliare</h1>
            <p class="text-lg text-gray-600">Analisi di fattibilit√† - Investimento Immobiliare</p>
            
            <!-- Scenario Tabs -->
            <div class="flex justify-center mt-6 space-x-4 no-print">
                <button onclick="loadScenario('milan-airbnb')" id="tab-milan-airbnb" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                    üè† Affitti Brevi Milano
                </button>
                <button onclick="loadScenario('catania-airbnb')" id="tab-catania-airbnb" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition duration-200">
                    üåä Affitti Brevi Catania
                </button>
                <button onclick="loadScenario('milan-residence')" id="tab-milan-residence" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition duration-200">
                    üè° Residenza Milano
                </button>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Input Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 no-print">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <span class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm mr-3">1</span>
                    Dati dell'Investimento
                </h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prezzo di Acquisto (‚Ç¨)</label>
                        <input type="number" id="purchasePrice" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 120000" value="120000">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Capitale Proprio (‚Ç¨)</label>
                            <input type="number" id="ownCapital" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 35000" value="35000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Importo Mutuo (‚Ç¨)</label>
                            <input type="number" id="mortgageAmount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 85000" value="85000">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Rata Mutuo Mensile (‚Ç¨)</label>
                        <input type="number" id="mortgagePayment" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 550" value="550">
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-800 mb-3">Tipo di Affitto</h3>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="rentalType" value="traditional" class="mr-2" checked>
                                <span>Affitto Tradizionale</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="rentalType" value="shortterm" class="mr-2">
                                <span>Affitti Brevi (Airbnb)</span>
                            </label>
                        </div>
                    </div>

                    <div id="traditionalInputs">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Affitto Mensile Tradizionale (‚Ç¨)</label>
                        <input type="number" id="monthlyRent" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 900" value="900">
                    </div>

                    <div id="shorttermInputs" style="display: none;">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tariffa Notte (‚Ç¨)</label>
                                <input type="number" id="nightlyRate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 65" value="65">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Occupazione (%)</label>
                                <input type="number" id="occupancyRate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 70" value="70" min="0" max="100">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Costo Pulizie per Soggiorno (‚Ç¨)</label>
                            <input type="number" id="cleaningCost" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 25" value="25">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Spese Condominiali Mensili (‚Ç¨)</label>
                        <input type="number" id="condoFees" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 120" value="120">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Utenze Mensili (‚Ç¨)</label>
                        <input type="number" id="utilities" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 80" value="80">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">IMU Annuale - Prima Casa (‚Ç¨)</label>
                            <input type="number" id="imuFirstHome" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 0" value="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">IMU Annuale - Seconda Casa (‚Ç¨)</label>
                            <input type="number" id="imuSecondHome" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 1800" value="1800">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">TARI Annuale (‚Ç¨)</label>
                        <input type="number" id="tari" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 180" value="180">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Manutenzioni Annuali (‚Ç¨)</label>
                        <input type="number" id="maintenance" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="es. 1200" value="1200">
                    </div>

                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-800 mb-3">Altri Costi</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Assicurazione Casa (‚Ç¨/anno)</label>
                                <input type="number" id="insurance" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="es. 300" value="300">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amministratore (‚Ç¨/anno)</label>
                                <input type="number" id="administrator" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="es. 200" value="200">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Commissioni Airbnb (%)</label>
                                <input type="number" id="airbnbCommission" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="es. 3" value="3" step="0.1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cedolare Secca (%)</label>
                                <input type="number" id="taxRate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="es. 21" value="21" step="0.1">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Imposta di Soggiorno (‚Ç¨/notte)</label>
                                <input type="number" id="cityTax" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="es. 3" value="3" step="0.1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Spese Varie/Imprevisti (‚Ç¨/anno)</label>
                                <input type="number" id="miscExpenses" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="es. 500" value="500">
                            </div>
                        </div>
                    </div>

                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-800 mb-3">üè† Agevolazione Prima Casa (2028-2032)</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">RAL Attuale (‚Ç¨)</label>
                                <input type="number" id="currentSalary" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="es. 47000" value="47000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Aumento Annuale (%)</label>
                                <input type="number" id="salaryIncrease" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="es. 2.5" value="2.5" step="0.1">
                            </div>
                        </div>
                        <p class="text-xs text-gray-600 mt-2">Tassazione ridotta al 50% della RAL per 5 anni dal 2028</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button onclick="calculateROI()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                            Calcola Fattibilit√†
                        </button>
                        <button onclick="printReport()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                            üñ®Ô∏è Stampa Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <span class="bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm mr-3">2</span>
                    Analisi Finanziaria
                </h2>

                <div id="results" class="space-y-6">
                    <!-- Investment Summary -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Capitale Proprio Investito</h3>
                        <div class="text-2xl font-bold text-blue-600" id="totalInvestment">‚Ç¨ 35.000</div>
                        <p class="text-sm text-gray-600 mt-1">Escluso mutuo di <span id="mortgageDisplay">‚Ç¨ 85.000</span></p>
                    </div>

                    <!-- Annual Income -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Ricavi Annuali</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span id="incomeLabel">Affitti:</span>
                                <span id="annualRent" class="font-semibold">‚Ç¨ 10.800</span>
                            </div>
                        </div>
                        <div class="border-t pt-2 mt-2">
                            <div class="flex justify-between text-lg font-bold text-green-600">
                                <span>Totale Ricavi:</span>
                                <span id="totalIncome">‚Ç¨ 10.800</span>
                            </div>
                        </div>
                    </div>

                    <!-- Annual Expenses -->
                    <div class="bg-red-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Spese Annuali</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Rate Mutuo:</span>
                                <span id="annualMortgage" class="font-semibold">‚Ç¨ 6.600</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Condominio:</span>
                                <span id="annualCondo" class="font-semibold">‚Ç¨ 1.440</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Utenze:</span>
                                <span id="annualUtilities" class="font-semibold">‚Ç¨ 960</span>
                            </div>
                            <div class="flex justify-between">
                                <span>IMU:</span>
                                <span id="annualIMU" class="font-semibold">‚Ç¨ 0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>TARI:</span>
                                <span id="annualTARI" class="font-semibold">‚Ç¨ 180</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Manutenzioni:</span>
                                <span id="annualMaintenance" class="font-semibold">‚Ç¨ 1.200</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tasse (21%):</span>
                                <span id="taxes" class="font-semibold">‚Ç¨ 2.268</span>
                            </div>
                            <div class="flex justify-between" id="cleaningRow" style="display: none;">
                                <span>Pulizie Airbnb:</span>
                                <span id="annualCleaning" class="font-semibold">‚Ç¨ 0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Assicurazione:</span>
                                <span id="annualInsurance" class="font-semibold">‚Ç¨ 300</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Amministratore:</span>
                                <span id="annualAdministrator" class="font-semibold">‚Ç¨ 200</span>
                            </div>
                            <div class="flex justify-between" id="commissionRow" style="display: none;">
                                <span>Commissioni Airbnb:</span>
                                <span id="annualCommissions" class="font-semibold">‚Ç¨ 0</span>
                            </div>
                            <div class="flex justify-between" id="cityTaxRow" style="display: none;">
                                <span>Imposta Soggiorno:</span>
                                <span id="annualCityTax" class="font-semibold">‚Ç¨ 0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Spese Varie:</span>
                                <span id="annualMiscExpenses" class="font-semibold">‚Ç¨ 500</span>
                            </div>
                        </div>
                        <div class="border-t pt-2 mt-2">
                            <div class="flex justify-between text-lg font-bold text-red-600">
                                <span>Totale Spese:</span>
                                <span id="totalExpenses">‚Ç¨ 12.648</span>
                            </div>
                        </div>
                    </div>

                    <!-- Cash Flow -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Cash Flow Annuale</h3>
                        <div class="text-2xl font-bold" id="cashFlow">-‚Ç¨ 1.848</div>
                        <p class="text-sm text-gray-600 mt-1">Entrate - Uscite (incluso mutuo)</p>
                    </div>

                    <!-- ROI -->
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">ROI sul Capitale Proprio</h3>
                        <div class="text-3xl font-bold text-yellow-600" id="roi">-5.28%</div>
                        <p class="text-sm text-gray-600 mt-1">Rendimento sul capitale investito</p>
                    </div>

                    <!-- IMU Timeline -->
                    <div class="bg-orange-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">‚ö†Ô∏è Attenzione IMU</h3>
                        <p class="text-sm text-gray-700">Dopo 18 mesi senza residenza: <strong>+‚Ç¨ 1.800/anno</strong></p>
                        <div class="text-lg font-bold text-orange-600" id="futureROI">ROI futuro: -10.42%</div>
                    </div>

                    <!-- Tax Benefits -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">üí∞ Beneficio Fiscale Prima Casa</h3>
                        <p class="text-sm text-gray-700">Dal 2028 al 2032 (5 anni):</p>
                        <div class="text-lg font-bold text-green-600" id="taxBenefit">+‚Ç¨ 0/anno</div>
                        <p class="text-xs text-gray-500 mt-1" id="taxBenefitDetails">Risparmio su tassazione RAL ridotta al 50%</p>
                    </div>
                </div>

                <!-- Recommendation -->
                <div id="recommendation" class="mt-6 p-4 rounded-lg border-l-4">
                    <h3 class="font-semibold mb-2">Valutazione</h3>
                    <p id="recommendationText" class="text-sm"></p>
                </div>
            </div>
        </div>

        <!-- Additional Analysis -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Confronto Scenari</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <h3 class="font-semibold text-gray-700 mb-2">Affitti Brevi (Airbnb)</h3>
                    <p class="text-sm text-gray-600 mb-2">‚Ç¨65/notte, 70% occupazione</p>
                    <div class="text-xl font-bold text-green-600" id="shorttermROI">+2.1%</div>
                    <p class="text-xs text-gray-500 mt-1">Cash flow: +‚Ç¨735/anno</p>
                </div>
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold text-gray-700 mb-2">Affitto Tradizionale</h3>
                    <p class="text-sm text-gray-600 mb-2">‚Ç¨900/mese</p>
                    <div class="text-xl font-bold text-blue-600" id="traditionalROI">-5.3%</div>
                    <p class="text-xs text-gray-500 mt-1">Cash flow: -‚Ç¨1.848/anno</p>
                </div>
            </div>
            
            <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                <h3 class="font-semibold text-gray-800 mb-2">üí° Raccomandazioni</h3>
                <ul class="text-sm text-gray-700 space-y-1">
                    <li>‚Ä¢ Considera affitti brevi per migliorare la redditivit√†</li>
                    <li>‚Ä¢ Negozia ulteriormente il prezzo (obiettivo: ‚Ç¨110k o meno)</li>
                    <li>‚Ä¢ Valuta zone con affitti pi√π alti (‚Ç¨1000+/mese)</li>
                    <li>‚Ä¢ Mantieni la residenza per 18+ mesi per risparmiare IMU</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Scenario data
        const scenarios = {
            'milan-airbnb': {
                purchasePrice: 120000,
                nightlyRate: 65,
                occupancyRate: 70,
                condoFees: 120,
                utilities: 80,
                imuSecondHome: 1800,
                tari: 180,
                maintenance: 1200,
                cleaningCost: 25,
                insurance: 300,
                administrator: 200,
                airbnbCommission: 3,
                cityTax: 3,
                miscExpenses: 500,
                taxRate: 21
            },
            'catania-airbnb': {
                purchasePrice: 80000,
                nightlyRate: 45,
                occupancyRate: 65,
                condoFees: 80,
                utilities: 60,
                imuSecondHome: 1200,
                tari: 120,
                maintenance: 800,
                cleaningCost: 20,
                insurance: 250,
                administrator: 150,
                airbnbCommission: 3,
                cityTax: 2,
                miscExpenses: 400,
                taxRate: 21
            },
            'milan-residence': {
                purchasePrice: 120000,
                monthlyRent: 0, // No rental income as it's residence
                condoFees: 120,
                utilities: 80,
                imuFirstHome: 0, // First home benefits
                tari: 180,
                maintenance: 1200,
                insurance: 300,
                administrator: 200,
                miscExpenses: 500,
                taxRate: 0 // No rental tax as no rental income
            }
        };

        function loadScenario(scenarioKey) {
            const scenario = scenarios[scenarioKey];
            
            // Update tab appearance
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.className = 'px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition duration-200';
            });
            document.getElementById(`tab-${scenarioKey}`).className = 'px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-200';
            
            // Update form values
            Object.keys(scenario).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = scenario[key];
                }
            });
            
            // Set rental type based on scenario
            if (scenarioKey.includes('airbnb')) {
                document.querySelector('input[name="rentalType"][value="shortterm"]').checked = true;
            } else {
                document.querySelector('input[name="rentalType"][value="traditional"]').checked = true;
            }
            
            // Update mortgage amounts based on purchase price
            const ownCapital = 35000;
            const mortgageAmount = scenario.purchasePrice - ownCapital;
            document.getElementById('ownCapital').value = ownCapital;
            document.getElementById('mortgageAmount').value = mortgageAmount;
            
            // Adjust mortgage payment based on amount (rough estimate)
            const mortgagePayment = Math.round(mortgageAmount * 0.0065); // ~0.65% monthly
            document.getElementById('mortgagePayment').value = mortgagePayment;
            
            toggleRentalInputs();
            calculateROI();
        }

        function calculateROI() {
            // Get input values
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const ownCapital = parseFloat(document.getElementById('ownCapital').value) || 0;
            const mortgageAmount = parseFloat(document.getElementById('mortgageAmount').value) || 0;
            const mortgagePayment = parseFloat(document.getElementById('mortgagePayment').value) || 0;
            const monthlyRent = parseFloat(document.getElementById('monthlyRent').value) || 0;
            const nightlyRate = parseFloat(document.getElementById('nightlyRate').value) || 0;
            const occupancyRate = parseFloat(document.getElementById('occupancyRate').value) || 0;
            const cleaningCost = parseFloat(document.getElementById('cleaningCost').value) || 0;
            const condoFees = parseFloat(document.getElementById('condoFees').value) || 0;
            const utilities = parseFloat(document.getElementById('utilities').value) || 0;
            const imuFirstHome = parseFloat(document.getElementById('imuFirstHome').value) || 0;
            const imuSecondHome = parseFloat(document.getElementById('imuSecondHome').value) || 0;
            const tari = parseFloat(document.getElementById('tari').value) || 0;
            const maintenance = parseFloat(document.getElementById('maintenance').value) || 0;
            const currentSalary = parseFloat(document.getElementById('currentSalary').value) || 0;
            const salaryIncrease = parseFloat(document.getElementById('salaryIncrease').value) || 0;
            const insurance = parseFloat(document.getElementById('insurance').value) || 0;
            const administrator = parseFloat(document.getElementById('administrator').value) || 0;
            const airbnbCommission = parseFloat(document.getElementById('airbnbCommission').value) || 0;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const cityTax = parseFloat(document.getElementById('cityTax').value) || 0;
            const miscExpenses = parseFloat(document.getElementById('miscExpenses').value) || 0;

            // Determine rental type
            const rentalType = document.querySelector('input[name="rentalType"]:checked').value;
            
            // Calculate annual income based on rental type
            let annualRent, incomeLabel, annualCleaning = 0, annualCommissions = 0, annualCityTax = 0;
            if (rentalType === 'shortterm') {
                const nightsPerYear = 365 * (occupancyRate / 100);
                const bookingsPerYear = nightsPerYear / 2.5; // Average 2.5 nights per booking
                const grossRent = nightlyRate * nightsPerYear;
                annualCommissions = grossRent * (airbnbCommission / 100);
                annualCityTax = nightsPerYear * cityTax;
                annualRent = grossRent - annualCommissions; // Net after Airbnb commission
                annualCleaning = cleaningCost * bookingsPerYear;
                incomeLabel = `Airbnb (${Math.round(nightsPerYear)} notti):`;
                document.getElementById('cleaningRow').style.display = 'flex';
                document.getElementById('commissionRow').style.display = 'flex';
                document.getElementById('cityTaxRow').style.display = 'flex';
            } else {
                annualRent = monthlyRent * 12;
                incomeLabel = 'Affitti tradizionali:';
                document.getElementById('cleaningRow').style.display = 'none';
                document.getElementById('commissionRow').style.display = 'none';
                document.getElementById('cityTaxRow').style.display = 'none';
            }

            // Calculate annual expenses
            const annualMortgage = mortgagePayment * 12;
            const annualCondo = condoFees * 12;
            const annualUtilities = utilities * 12;
            const annualMaintenance = maintenance;
            const annualTARI = tari;
            const annualIMU = imuFirstHome; // Start with first home benefits
            const taxes = annualRent * (taxRate / 100); // Cedolare secca on rental income
            
            const totalExpenses = annualMortgage + annualCondo + annualUtilities + annualIMU + annualTARI + annualMaintenance + taxes + annualCleaning + insurance + administrator + annualCityTax + miscExpenses;

            // Calculate cash flow and ROI
            const cashFlow = annualRent - totalExpenses;
            const roi = ownCapital > 0 ? (cashFlow / ownCapital) * 100 : 0;

            // Calculate future scenario with second home IMU
            const futureExpenses = annualMortgage + annualCondo + annualUtilities + imuSecondHome + annualTARI + annualMaintenance + taxes + annualCleaning;
            const futureCashFlow = annualRent - futureExpenses;
            const futureROI = ownCapital > 0 ? (futureCashFlow / ownCapital) * 100 : 0;

            // Calculate tax benefit from first home purchase (2028-2032)
            // Current tax rate approximately 38% on 47k salary
            const currentTaxRate = 0.38;
            const reducedTaxRate = 0.19; // 50% reduction
            let avgSalaryDuringBenefit = currentSalary;
            for (let i = 1; i <= 4; i++) { // 4 years of increases to reach 2028
                avgSalaryDuringBenefit *= (1 + salaryIncrease / 100);
            }
            const annualTaxSavings = avgSalaryDuringBenefit * (currentTaxRate - reducedTaxRate);
            const totalTaxBenefit = annualTaxSavings * 5; // 5 years of benefit

            // Update display
            document.getElementById('totalInvestment').textContent = `‚Ç¨ ${ownCapital.toLocaleString()}`;
            document.getElementById('mortgageDisplay').textContent = `‚Ç¨ ${mortgageAmount.toLocaleString()}`;
            document.getElementById('incomeLabel').textContent = incomeLabel;
            document.getElementById('annualRent').textContent = `‚Ç¨ ${annualRent.toLocaleString()}`;
            document.getElementById('totalIncome').textContent = `‚Ç¨ ${annualRent.toLocaleString()}`;
            document.getElementById('annualMortgage').textContent = `‚Ç¨ ${annualMortgage.toLocaleString()}`;
            document.getElementById('annualCondo').textContent = `‚Ç¨ ${annualCondo.toLocaleString()}`;
            document.getElementById('annualUtilities').textContent = `‚Ç¨ ${annualUtilities.toLocaleString()}`;
            document.getElementById('annualIMU').textContent = `‚Ç¨ ${annualIMU.toLocaleString()}`;
            document.getElementById('annualTARI').textContent = `‚Ç¨ ${annualTARI.toLocaleString()}`;
            document.getElementById('annualMaintenance').textContent = `‚Ç¨ ${annualMaintenance.toLocaleString()}`;
            document.getElementById('taxes').textContent = `‚Ç¨ ${taxes.toLocaleString()}`;
            document.getElementById('annualCleaning').textContent = `‚Ç¨ ${annualCleaning.toLocaleString()}`;
            document.getElementById('annualInsurance').textContent = `‚Ç¨ ${insurance.toLocaleString()}`;
            document.getElementById('annualAdministrator').textContent = `‚Ç¨ ${administrator.toLocaleString()}`;
            document.getElementById('annualCommissions').textContent = `‚Ç¨ ${annualCommissions.toLocaleString()}`;
            document.getElementById('annualCityTax').textContent = `‚Ç¨ ${annualCityTax.toLocaleString()}`;
            document.getElementById('annualMiscExpenses').textContent = `‚Ç¨ ${miscExpenses.toLocaleString()}`;
            document.getElementById('totalExpenses').textContent = `‚Ç¨ ${totalExpenses.toLocaleString()}`;
            
            // Update cash flow with color coding
            const cashFlowElement = document.getElementById('cashFlow');
            cashFlowElement.textContent = `${cashFlow >= 0 ? '' : '-'}‚Ç¨ ${Math.abs(cashFlow).toLocaleString()}`;
            cashFlowElement.className = `text-2xl font-bold ${cashFlow >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            document.getElementById('roi').textContent = `${roi.toFixed(2)}%`;
            document.getElementById('futureROI').textContent = `ROI futuro: ${futureROI.toFixed(2)}%`;
            
            // Update tax benefit display
            document.getElementById('taxBenefit').textContent = `+‚Ç¨ ${annualTaxSavings.toLocaleString()}`;
            document.getElementById('taxBenefitDetails').textContent = `Totale 5 anni: ‚Ç¨${totalTaxBenefit.toLocaleString()} | RAL 2028: ‚Ç¨${Math.round(avgSalaryDuringBenefit).toLocaleString()}`;

            // Calculate comparison scenarios
            const shorttermIncome = nightlyRate * 365 * 0.7; // 70% occupancy
            const shorttermCleaningCosts = cleaningCost * (365 * 0.7 / 2.5); // cleaning per booking
            const shorttermExpenses = annualMortgage + annualCondo + annualUtilities + annualIMU + annualTARI + annualMaintenance + (shorttermIncome * 0.21) + shorttermCleaningCosts;
            const shorttermCashFlow = shorttermIncome - shorttermExpenses;
            const shorttermROI = ownCapital > 0 ? (shorttermCashFlow / ownCapital) * 100 : 0;

            const traditionalIncome = monthlyRent * 12;
            const traditionalExpenses = annualMortgage + annualCondo + annualUtilities + annualIMU + annualTARI + annualMaintenance + (traditionalIncome * 0.21);
            const traditionalCashFlow = traditionalIncome - traditionalExpenses;
            const traditionalROI = ownCapital > 0 ? (traditionalCashFlow / ownCapital) * 100 : 0;

            document.getElementById('shorttermROI').textContent = `${shorttermROI >= 0 ? '+' : ''}${shorttermROI.toFixed(1)}%`;
            document.getElementById('traditionalROI').textContent = `${traditionalROI.toFixed(1)}%`;

            // Update scenario cash flows
            document.querySelector('#shorttermROI').parentElement.querySelector('.text-xs').textContent = 
                `Cash flow: ${shorttermCashFlow >= 0 ? '+' : ''}‚Ç¨${shorttermCashFlow.toLocaleString()}/anno`;
            document.querySelector('#traditionalROI').parentElement.querySelector('.text-xs').textContent = 
                `Cash flow: ${traditionalCashFlow >= 0 ? '+' : ''}‚Ç¨${traditionalCashFlow.toLocaleString()}/anno`;

            // Recommendation
            const recommendationDiv = document.getElementById('recommendation');
            const recommendationText = document.getElementById('recommendationText');

            if (cashFlow >= 0 && roi >= 3) {
                recommendationDiv.className = 'mt-6 p-4 rounded-lg border-l-4 bg-green-50 border-green-500';
                recommendationText.textContent = 'Investimento interessante! Cash flow positivo e buon rendimento sul capitale.';
            } else if (cashFlow >= 0) {
                recommendationDiv.className = 'mt-6 p-4 rounded-lg border-l-4 bg-yellow-50 border-yellow-500';
                recommendationText.textContent = 'Investimento equilibrato. Cash flow positivo ma rendimento modesto.';
            } else {
                recommendationDiv.className = 'mt-6 p-4 rounded-lg border-l-4 bg-red-50 border-red-500';
                recommendationText.textContent = 'Attenzione: Cash flow negativo. Dovrai integrare mensilmente per coprire le spese.';
            }
        }

        // Toggle rental type inputs
        function toggleRentalInputs() {
            const rentalType = document.querySelector('input[name="rentalType"]:checked').value;
            const traditionalInputs = document.getElementById('traditionalInputs');
            const shorttermInputs = document.getElementById('shorttermInputs');
            
            if (rentalType === 'shortterm') {
                traditionalInputs.style.display = 'none';
                shorttermInputs.style.display = 'block';
            } else {
                traditionalInputs.style.display = 'block';
                shorttermInputs.style.display = 'none';
            }
            calculateROI();
        }

        // Print function
        function printReport() {
            // Get current scenario name
            const activeTab = document.querySelector('[id^="tab-"][class*="bg-blue-600"]');
            let scenarioName = 'Scenario Personalizzato';
            
            if (activeTab) {
                const tabId = activeTab.id;
                if (tabId.includes('milan-airbnb')) {
                    scenarioName = 'Affitti Brevi Milano';
                } else if (tabId.includes('catania-airbnb')) {
                    scenarioName = 'Affitti Brevi Catania';
                } else if (tabId.includes('milan-residence')) {
                    scenarioName = 'Residenza Milano';
                }
            }
            
            // Update print title and date
            document.getElementById('printTitle').textContent = `Business Plan Immobiliare - ${scenarioName}`;
            document.getElementById('printSubtitle').textContent = 'Analisi di fattibilit√† dettagliata';
            document.getElementById('printDate').textContent = `Generato il ${new Date().toLocaleDateString('it-IT', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}`;
            
            // Trigger print
            window.print();
        }

        // Load default scenario and calculate on page load
        loadScenario('milan-airbnb');

        // Add event listeners
        const inputs = ['purchasePrice', 'ownCapital', 'mortgageAmount', 'mortgagePayment', 'monthlyRent', 'nightlyRate', 'occupancyRate', 'cleaningCost', 'condoFees', 'utilities', 'imuFirstHome', 'imuSecondHome', 'tari', 'maintenance', 'currentSalary', 'salaryIncrease', 'insurance', 'administrator', 'airbnbCommission', 'taxRate', 'cityTax', 'miscExpenses'];
        inputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', calculateROI);
            }
        });

        // Add rental type change listeners
        document.querySelectorAll('input[name="rentalType"]').forEach(radio => {
            radio.addEventListener('change', toggleRentalInputs);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97a7845f9034c4e2',t:'MTc1NzA5NDA4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
